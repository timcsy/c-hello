!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class t{constructor(){const t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("Web Audio API 不支援，將使用視覺回饋模式"),void(this.ctx=null);this.ctx=new t,this.isSupported=!0,this.isMuted=!1,this.volume=.5,this.ditDuration=100,this.dahDuration=300}setParams({ditDuration:t,dahDuration:e}){void 0!==t&&(this.ditDuration=t),void 0!==e&&(this.dahDuration=e)}playDit(){if(!this.isMuted&&this.ctx)try{this._playTone(this.ditDuration)}catch(t){console.error("播放點音頻失敗:",t)}}playDah(){if(!this.isMuted&&this.ctx)try{this._playTone(this.dahDuration)}catch(t){console.error("播放劃音頻失敗:",t)}}_playTone(t){if(!this.ctx)return;const e=this.ctx.currentTime,s=this.ctx.createOscillator(),i=this.ctx.createGain();s.connect(i),i.connect(this.ctx.destination),s.frequency.value=600,i.gain.setValueAtTime(this.volume,e),i.gain.exponentialRampToValueAtTime(.01,e+t/1e3),s.start(e),s.stop(e+t/1e3)}setVolume(t){this.volume=Math.max(0,Math.min(1,t))}toggleMute(){return this.isMuted=!this.isMuted,this.isMuted}isAudioSupported(){return this.isSupported&&null!==this.ctx}}const e={A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----.",".":".-.-.-",",":"--..--","?":"..--..","'":".----.","!":"-.-.--","/":"-..-.","(":"-.--.-",")":"-.--.-","&":".-...",":":"---...",";":"-.-.-.","=":"-...-","+":".-.-.","-":"-....-",_:"..--.-",'"':".-..-.",$:"...-..-","@":".--.-."},s=Object.entries(e).reduce((t,[e,s])=>(t[s]=e,t),{});class i{constructor(){this.morseDisplay=document.getElementById("morse-display"),this.textDisplay=document.getElementById("text-display"),this.stats=document.getElementById("stats"),this.inputArea=document.getElementById("input-area"),this.visualFeedback=document.getElementById("visual-feedback")}updateMorseSymbols(t){this.morseDisplay&&(this.morseDisplay.textContent=t||"待輸入...")}updateDecodedText(t){this.textDisplay&&(this.textDisplay.textContent=t||"")}updateStats(t,e=null,s=null,i=null){if(!this.stats)return;let n=`<p>字元數: ${t}</p>`;null!==e&&(n+=`<p>正確數: ${e}</p>`),null!==s&&(n+=`<p>準確率: ${s}%</p>`),null!==i&&(n+=`<p>練習時長: ${i}s</p>`),this.stats.innerHTML=n}showVisualFeedback(t){if(!this.visualFeedback)return;const e="dit"===t?"feedback-dit":"feedback-dah";this.visualFeedback.classList.add(e),setTimeout(()=>{this.visualFeedback.classList.remove(e)},"dit"===t?100:300)}showChallengeChar(t){const e=document.getElementById("challenge-char");e&&(e.textContent=t)}showCorrectness(t){const e=document.getElementById("correctness-feedback");e&&(e.textContent=t?"✓ 正確!":"✗ 錯誤!",e.className=t?"correct":"incorrect")}clear(){this.updateMorseSymbols(""),this.updateDecodedText(""),this.updateStats(0)}}class n{constructor(t,e,s){this.onDit=t,this.onDah=e,this.onCharEnd=s,this.isPressed=!1,this.pressStartTime=null,this.touchId=null,this.ditThreshold=100,this.charEndTimeout=300,this.charEndTimer=null}setParams({ditDuration:t,charInterval:e}){void 0!==t&&(this.ditThreshold=t),void 0!==e&&(this.charEndTimeout=e)}init(t=" "){document.addEventListener("keydown",t=>{"Space"!==t.code&&" "!==t.key||(t.preventDefault(),this._onPressStart())}),document.addEventListener("keyup",t=>{"Space"!==t.code&&" "!==t.key||(t.preventDefault(),this._onPressEnd())});const e=document.getElementById("input-area");e&&(e.addEventListener("touchstart",t=>this._onTouchStart(t),!1),e.addEventListener("touchend",t=>this._onTouchEnd(t),!1))}_onPressStart(){this.isPressed||(this.isPressed=!0,this.pressStartTime=Date.now(),this.charEndTimer&&(clearTimeout(this.charEndTimer),this.charEndTimer=null))}_onPressEnd(){if(!this.isPressed)return;this.isPressed=!1;Date.now()-this.pressStartTime<=this.ditThreshold?this.onDit():this.onDah(),this.charEndTimer&&clearTimeout(this.charEndTimer),this.charEndTimer=setTimeout(()=>{this.onCharEnd(),this.charEndTimer=null},this.charEndTimeout)}_onTouchStart(t){null===this.touchId&&t.touches.length>0&&(this.touchId=t.touches[0].identifier,this._onPressStart())}_onTouchEnd(t){if(null===this.touchId)return;let e=!1;for(let s=0;s<t.touches.length;s++)if(t.touches[s].identifier===this.touchId){e=!0;break}e||(this._onPressEnd(),this.touchId=null)}}const r="morse-trainer-prefs",o={ditDuration:100,dahDuration:300,charInterval:300,wordInterval:700,volume:.5,isMuted:!1,mode:"free"};function a(){try{const t=localStorage.getItem(r);return t?{...o,...JSON.parse(t)}:{...o}}catch(t){return console.warn("讀取 LocalStorage 失敗:",t),{...o}}}function h(t,e){const s=a();s[t]=e,function(t){try{const e={...a(),...t};localStorage.setItem(r,JSON.stringify(e))}catch(e){console.warn("保存 LocalStorage 失敗:",e)}}(s)}class d{constructor(){this.audioEngine=new t,this.ui=new i,this.prefs=a(),this.currentMode=this.prefs.mode||"free",this.currentMorse="",this.decodedText="",this.charCount=0,this.startTime=null,this.challengeChar="A",this.correctCount=0,this.challengeCount=0,this.charEndTimer=null,this.init()}init(){this._setupAudio(),this._setupInputHandler(),this._setupUIListeners(),this._setupParamListeners(),this._loadPreferences(),this._updateDisplay(),console.log("摩斯密碼練習應用已初始化")}_setupAudio(){this.audioEngine.setParams({ditDuration:this.prefs.ditDuration,dahDuration:this.prefs.dahDuration}),this.audioEngine.setVolume(this.prefs.volume),this.audioEngine.isMuted=this.prefs.isMuted}_setupInputHandler(){this.inputHandler=new n(()=>this._onDit(),()=>this._onDah(),()=>this._onCharEnd()),this.inputHandler.setParams({ditDuration:this.prefs.ditDuration,charInterval:this.prefs.charInterval}),this.inputHandler.init()}_setupUIListeners(){document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",t=>{this._switchMode(t.target.dataset.mode)})});const t=document.getElementById("clear-btn");t&&t.addEventListener("click",()=>this._clear());const e=document.getElementById("reset-btn");e&&e.addEventListener("click",()=>this._resetDefaults());const s=document.getElementById("mute-toggle");s&&(s.checked=this.audioEngine.isMuted,s.addEventListener("change",t=>{this.audioEngine.isMuted=t.target.checked,h("isMuted",t.target.checked)}))}_setupParamListeners(){const t=document.getElementById("dit-duration");t&&(t.value=this.prefs.ditDuration,t.addEventListener("input",t=>{const e=parseInt(t.target.value);this.prefs.ditDuration=e,this.audioEngine.ditDuration=e,this.inputHandler.ditThreshold=e,h("ditDuration",e),document.getElementById("dit-value").textContent=e}),document.getElementById("dit-value").textContent=this.prefs.ditDuration);const e=document.getElementById("dah-duration");e&&(e.value=this.prefs.dahDuration,e.addEventListener("input",t=>{const e=parseInt(t.target.value);this.prefs.dahDuration=e,this.audioEngine.dahDuration=e,h("dahDuration",e),document.getElementById("dah-value").textContent=e}),document.getElementById("dah-value").textContent=this.prefs.dahDuration);const s=document.getElementById("char-interval");s&&(s.value=this.prefs.charInterval,s.addEventListener("input",t=>{const e=parseInt(t.target.value);this.prefs.charInterval=e,this.inputHandler.charEndTimeout=e,h("charInterval",e),document.getElementById("char-value").textContent=e}),document.getElementById("char-value").textContent=this.prefs.charInterval);const i=document.getElementById("word-interval");i&&(i.value=this.prefs.wordInterval,i.addEventListener("input",t=>{const e=parseInt(t.target.value);this.prefs.wordInterval=e,h("wordInterval",e),document.getElementById("word-value").textContent=e}),document.getElementById("word-value").textContent=this.prefs.wordInterval);const n=document.getElementById("volume");n&&(n.value=100*this.prefs.volume,n.addEventListener("input",t=>{const e=parseInt(t.target.value),s=e/100;this.prefs.volume=s,this.audioEngine.setVolume(s),h("volume",s),document.getElementById("volume-value").textContent=e+"%"}),document.getElementById("volume-value").textContent=Math.round(100*this.prefs.volume)+"%")}_loadPreferences(){const t=document.getElementById("mute-toggle");t&&(t.checked=this.prefs.isMuted)}_onDit(){this.startTime||(this.startTime=Date.now()),this.currentMorse+=".",this.audioEngine.playDit(),this.ui.showVisualFeedback("dit"),this._updateDisplay()}_onDah(){this.startTime||(this.startTime=Date.now()),this.currentMorse+="-",this.audioEngine.playDah(),this.ui.showVisualFeedback("dah"),this._updateDisplay()}_onCharEnd(){if(""===this.currentMorse)return;const t=(e=this.currentMorse,s[e]||"?");var e;this.decodedText+=t,this.charCount++,"challenge"===this.currentMode&&this._validateChallenge(this.currentMorse,t),this.currentMorse="",this._updateDisplay()}_validateChallenge(t,s){const i=this.challengeChar.toUpperCase().split("").map(t=>e[t]||"?").join(" ");const n=t===i;this.ui.showCorrectness(n),n&&this.correctCount++,this.challengeCount++,setTimeout(()=>{this._generateChallenge()},800)}_generateChallenge(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ";this.challengeChar=t[Math.floor(26*Math.random())],this.ui.showChallengeChar(this.challengeChar),this.decodedText=""}_switchMode(t){if(t===this.currentMode)return;this.currentMode=t,h("mode",t),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.toggle("active",e.dataset.mode===t)});const e=document.getElementById("challenge-section");e&&e.classList.toggle("hidden","challenge"!==t),this._clear(),"challenge"===t&&this._generateChallenge()}_clear(){this.currentMorse="",this.decodedText="",this.charCount=0,this.correctCount=0,this.challengeCount=0,this.startTime=null,this.ui.clear()}_resetDefaults(){confirm("確定要重設所有偏好設定為預設值嗎？")&&(localStorage.removeItem("morse-trainer-prefs"),location.reload())}_updateDisplay(){this.ui.updateMorseSymbols(this.currentMorse),this.ui.updateDecodedText(this.decodedText);let t=null;if(this.startTime&&(t=Math.floor((Date.now()-this.startTime)/1e3)),"challenge"===this.currentMode){const e=this.challengeCount>0?Math.round(this.correctCount/this.challengeCount*100):0;this.ui.updateStats(this.charCount,this.correctCount,e,t)}else this.ui.updateStats(this.charCount,null,null,t)}}document.addEventListener("DOMContentLoaded",()=>{window.app=new d});
